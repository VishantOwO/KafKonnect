<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>KafKonnect - Real-Time Chat</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.5.2/dist/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        .chat-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .message-list {
            height: 500px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        .message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 5px;
            background-color: #f8f9fa;
        }
        .message-sender {
            font-weight: bold;
            color: #0d6efd;
        }
        .message-time {
            font-size: 0.8em;
            color: #6c757d;
        }
    </style>
</head>
<body>
<div class="chat-container">
    <h1 class="text-center mb-4">KafKonnect Chat</h1>
    <div class="mb-3">
        <h3>Topic: <span th:text="${topic}"></span></h3>
    </div>

    <div id="message-list" class="message-list">
        <div th:each="message : ${messages}" class="message">
            <div class="message-sender" th:text="${message.sender}"></div>
            <div class="message-content" th:text="${message.content}"></div>
            <div class="message-time" th:text="${message.timestamp}"></div>
        </div>
    </div>

    <div class="input-group mb-3">
        <input type="text" id="sender" class="form-control" placeholder="Your Name">
    </div>
    <div class="input-group mb-3">
        <input type="text" id="message-input" class="form-control" placeholder="Type your message here...">
        <button class="btn btn-primary" type="button" id="send-button">Send</button>
    </div>
</div>

<script th:inline="javascript">
    var stompClient = null;
    var topic = [[${topic}]];

    function connect() {
    var socket = new SockJS('/ws');
    stompClient = Stomp.over(socket);

    var token = localStorage.getItem('jwtToken');
    var headers = {};
    if (token) {
        headers['Authorization'] = 'Bearer ' + token;
    }

    stompClient.connect(headers, function(frame) {
        console.log('Connected: ' + frame);
        stompClient.subscribe('/topic/messages', function(message) {
            showMessage(JSON.parse(message.body));
        });
    });
}

    function disconnect() {
        if (stompClient !== null) {
            stompClient.disconnect();
        }
        console.log("Disconnected");
    }

    function sendMessage() {
        var sender = document.getElementById('sender').value;
        var content = document.getElementById('message-input').value;
        if (content && sender) {
            var message = {
                sender: sender,
                content: content,
                topic: topic
            };
            stompClient.send("/app/chat.sendMessage", {}, JSON.stringify(message));
            document.getElementById('message-input').value = '';
        }
    }

    function showMessage(message) {
        var messageList = document.getElementById('message-list');
        var messageElement = document.createElement('div');
        messageElement.className = 'message';

        var senderElement = document.createElement('div');
        senderElement.className = 'message-sender';
        senderElement.textContent = message.sender;

        var contentElement = document.createElement('div');
        contentElement.className = 'message-content';
        contentElement.textContent = message.content;

        var timeElement = document.createElement('div');
        timeElement.className = 'message-time';
        timeElement.textContent = new Date().toLocaleString();

        messageElement.appendChild(senderElement);
        messageElement.appendChild(contentElement);
        messageElement.appendChild(timeElement);

        messageList.appendChild(messageElement);
        messageList.scrollTop = messageList.scrollHeight;
    }

    window.onload = function() {
        connect();

        document.getElementById('send-button').addEventListener('click', function() {
            sendMessage();
        });

        document.getElementById('message-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    };

    window.onbeforeunload = function() {
        disconnect();
    };
    // After successful login
    function onLoginSuccess(token) {
        localStorage.setItem('jwtToken', token);
        connect();
    }
</script>
</body>
</html>